<div class="container-sm">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <%= link_to @host.name, host_path(@host.name) %>
      </li>
      <li class="breadcrumb-item">
        <%= link_to @repository.full_name, [@host, @repository] %>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        <%= @issue.pull_request ? 'Pull Request' : 'Issue' %> #<%= @issue.number %>
      </li>
    </ol>
  </nav>

  <div class="row">
    <div class="col-lg-8">
      <!-- Main Issue Content -->
      <div class="card mb-4">
        <div class="card-header d-flex align-items-center">
          <div class="flex-grow-1">
            <h1 class="h4 mb-0">
              <%= octicon "git-pull-request", class: "text-success me-2" if @issue.pull_request %>
              <%= octicon "issue-opened", class: "text-success me-2" unless @issue.pull_request %>
              <%= @issue.title %>
            </h1>
          </div>
          <div class="flex-shrink-0">
            <span class="badge bg-<%= @issue.state == 'open' ? 'success' : 'secondary' %> fs-6">
              <%= @issue.state.capitalize %>
            </span>
          </div>
        </div>
        
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Number:</strong> #<%= @issue.number %><br>
              <strong>Type:</strong> <%= @issue.pull_request ? 'Pull Request' : 'Issue' %><br>
              <strong>State:</strong> 
              <span class="badge bg-<%= @issue.state == 'open' ? 'success' : 'secondary' %>">
                <%= @issue.state.capitalize %>
              </span>
              <% if @issue.state_reason %>
                (<%= @issue.state_reason.humanize %>)
              <% end %>
            </div>
            <div class="col-md-6">
              <strong>Author:</strong> 
              <img src="https://github.com/<%= @issue.user.gsub('[bot]', '') %>.png" class="rounded me-2" height='20' width='20' alt="<%= @issue.user %>">
              <%= @issue.user %><br>
              <strong>Association:</strong> <%= @issue.author_association&.humanize || 'Unknown' %><br>
              <strong>Comments:</strong> <%= @issue.comments_count %>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Created:</strong> 
              <%= octicon "clock", class: "me-1" %>
              <%= @issue.created_at.strftime('%B %d, %Y at %I:%M %p UTC') %><br>
              <small class="text-muted">(<%= time_ago_in_words(@issue.created_at) %> ago)</small>
            </div>
            <div class="col-md-6">
              <strong>Updated:</strong> 
              <%= octicon "sync", class: "me-1" %>
              <%= @issue.updated_at.strftime('%B %d, %Y at %I:%M %p UTC') %><br>
              <small class="text-muted">(<%= time_ago_in_words(@issue.updated_at) %> ago)</small>
            </div>
          </div>

          <% if @issue.closed_at || @issue.merged_at %>
            <div class="row mb-3">
              <% if @issue.merged_at %>
                <div class="col-md-6">
                  <strong>Merged:</strong> 
                  <%= octicon "git-merge", class: "text-success me-1" %>
                  <%= @issue.merged_at.strftime('%B %d, %Y at %I:%M %p UTC') %><br>
                  <small class="text-muted">(<%= time_ago_in_words(@issue.merged_at) %> ago)</small>
                </div>
              <% elsif @issue.closed_at %>
                <div class="col-md-6">
                  <strong>Closed:</strong> 
                  <%= octicon "issue-closed", class: "text-danger me-1" %>
                  <%= @issue.closed_at.strftime('%B %d, %Y at %I:%M %p UTC') %><br>
                  <small class="text-muted">(<%= time_ago_in_words(@issue.closed_at) %> ago)</small>
                </div>
              <% end %>
              
              <% if @issue.time_to_close %>
                <div class="col-md-6">
                  <strong>Time to Close:</strong>
                  <%= octicon "stopwatch", class: "me-1" %>
                  <%= distance_of_time_in_words(@issue.time_to_close) %>
                </div>
              <% end %>
            </div>
          <% end %>

          <% if @issue.labels.any? %>
            <div class="mb-3">
              <strong>Labels:</strong><br>
              <% @issue.labels.each do |label| %>
                <span class="badge bg-light text-dark me-1 mb-1"><%= label %></span>
              <% end %>
            </div>
          <% end %>

          <% if @issue.assignees.any? %>
            <div class="mb-3">
              <strong>Assignees:</strong><br>
              <% @issue.assignees.each do |assignee| %>
                <span class="badge bg-info me-1 mb-1">
                  <%= octicon "person", class: "me-1" %><%= assignee %>
                </span>
              <% end %>
            </div>
          <% end %>

          <% if @issue.locked %>
            <div class="alert alert-warning mb-3">
              <%= octicon "lock", class: "me-2" %>
              This <%= @issue.pull_request ? 'pull request' : 'issue' %> is locked.
            </div>
          <% end %>
        </div>
      </div>

      <!-- Dependabot Metadata -->
      <% if @issue.dependency_metadata.present? %>
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">
              <%= octicon "package", class: "me-2" %>
              Dependency Information
            </h5>
          </div>
          <div class="card-body">
            <% metadata = @issue.dependency_metadata %>
            
            <div class="row">
              <% if metadata['package_name'] %>
                <div class="col-md-6 mb-3">
                  <strong>Package:</strong><br>
                  <code><%= metadata['package_name'] %></code>
                </div>
              <% end %>
              
              <% if metadata['ecosystem'] %>
                <div class="col-md-6 mb-3">
                  <strong>Ecosystem:</strong><br>
                  <span class="badge bg-primary"><%= metadata['ecosystem'] %></span>
                </div>
              <% end %>
              
              <% if metadata['previous_version'] %>
                <div class="col-md-6 mb-3">
                  <strong>Previous Version:</strong><br>
                  <code><%= metadata['previous_version'] %></code>
                </div>
              <% end %>
              
              <% if metadata['new_version'] %>
                <div class="col-md-6 mb-3">
                  <strong>New Version:</strong><br>
                  <code><%= metadata['new_version'] %></code>
                </div>
              <% end %>
              
              <% if metadata['update_type'] %>
                <div class="col-md-6 mb-3">
                  <strong>Update Type:</strong><br>
                  <span class="badge bg-<%= metadata['update_type'] == 'major' ? 'warning' : metadata['update_type'] == 'minor' ? 'info' : 'success' %>">
                    <%= metadata['update_type'].capitalize %>
                  </span>
                </div>
              <% end %>
            </div>

            <% if metadata.keys.any? { |k| !%w[package_name ecosystem previous_version new_version update_type].include?(k) } %>
              <details class="mt-3">
                <summary class="text-muted">Raw Metadata</summary>
                <pre class="mt-2 p-3 bg-light rounded"><%= JSON.pretty_generate(metadata) %></pre>
              </details>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header">
          <h6 class="mb-0">Actions</h6>
        </div>
        <div class="card-body">
          <%= link_to @issue.html_url, target: :_blank, class: "btn btn-primary w-100 mb-2" do %>
            <%= octicon "link-external", class: "me-2" %>
            View on GitHub
          <% end %>
          
          <%= link_to [@host, @repository], class: "btn btn-outline-secondary w-100 mb-2" do %>
            <%= octicon "repo", class: "me-2" %>
            View Repository
          <% end %>
          
          <%= link_to [@host, @repository, :issues], class: "btn btn-outline-secondary w-100" do %>
            <%= octicon "issue-opened", class: "me-2" %>
            All Issues
          <% end %>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h6 class="mb-0">Technical Details</h6>
        </div>
        <div class="card-body">
          <table class="table table-sm mb-0">
            <tr>
              <td><strong>UUID:</strong></td>
              <td><code><%= @issue.uuid %></code></td>
            </tr>
            <tr>
              <td><strong>Node ID:</strong></td>
              <td><code><%= @issue.node_id %></code></td>
            </tr>
            <tr>
              <td><strong>Host:</strong></td>
              <td><%= @host.name %></td>
            </tr>
            <tr>
              <td><strong>Repository:</strong></td>
              <td><%= @repository.full_name %></td>
            </tr>
          </table>
        </div>
      </div>

      <% if @issue.user.include?('[bot]') %>
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">Bot Information</h6>
          </div>
          <div class="card-body">
            <p class="mb-2">
              <%= octicon "hubot", class: "me-2" %>
              This <%= @issue.pull_request ? 'pull request' : 'issue' %> was created by a bot.
            </p>
            
            <% if @issue.user == 'dependabot[bot]' %>
              <div class="alert alert-info mb-0">
                <small>
                  <strong>Dependabot</strong> automatically creates pull requests to update dependencies 
                  when new versions are available. These updates help keep your project secure and up-to-date.
                </small>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>